<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Technicien en Temps R√©el</title>
    <!-- Twilio Voice JavaScript SDK via unpkg CDN -->
    <script src="https://unpkg.com/@twilio/voice-sdk@2.11.0/dist/twilio.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        .main-container {
            display: grid;
            grid-template-columns: 320px 450px 1fr;
            gap: 20px;
            height: 100vh;
            padding: 20px;
        }

        /* ============================================
           COLUMN 1: CUSTOMER & WORKSITE INFO
           ============================================ */
        .column-1 {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Customer Section (Top) */
        .customer-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            min-height: 200px;
        }

        .customer-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .customer-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            font-weight: bold;
            border: 3px solid #e3e8ef;
        }

        .customer-info h2 {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .customer-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .customer-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e3e8ef;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.95em;
        }

        .detail-label {
            color: #7f8c8d;
            font-weight: 500;
        }

        .detail-value {
            color: #2c3e50;
            font-weight: 600;
        }

        /* Worksite Section (Bottom - Larger) */
        .worksite-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            flex: 1;
            overflow-y: auto;
        }

        .worksite-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e3e8ef;
        }

        .worksite-avatar {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .worksite-info h3 {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .worksite-meta {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .equipment-list {
            margin-top: 20px;
        }

        .equipment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .equipment-name {
            color: #2c3e50;
            font-weight: 500;
        }

        .equipment-qty {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .subscription-badge {
            display: inline-block;
            padding: 8px 16px;
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            margin-top: 15px;
        }

        /* ============================================
           COLUMN 2: CALL CONTROLS & CHATBOT
           ============================================ */
        .column-2 {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Call Controls Section (Top) */
        .call-controls-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            min-height: 200px;
        }

        .call-status {
            text-align: center;
            margin-bottom: 20px;
        }

        .call-duration {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .call-state {
            color: #27ae60;
            font-weight: 600;
            font-size: 0.9em;
        }

        .call-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .call-btn.mute {
            background: #95a5a6;
            color: white;
        }

        .call-btn.mute:hover {
            background: #7f8c8d;
        }

        .call-btn.mute.active {
            background: #e74c3c;
        }

        .call-btn.end-call {
            background: #e74c3c;
            color: white;
        }

        .call-btn.end-call:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        /* Audio Waveform */
        .audio-waveform {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            height: 60px;
        }

        .waveform-bar {
            width: 6px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 3px;
            animation: wave 1s ease-in-out infinite;
        }

        .waveform-bar:nth-child(1) { animation-delay: 0s; }
        .waveform-bar:nth-child(2) { animation-delay: 0.1s; }
        .waveform-bar:nth-child(3) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(4) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(5) { animation-delay: 0.4s; }
        .waveform-bar:nth-child(6) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(7) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(8) { animation-delay: 0.1s; }

        @keyframes wave {
            0%, 100% { height: 20px; }
            50% { height: 50px; }
        }

        /* Chatbot Section (Bottom - Larger) */
        .chatbot-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chatbot-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e3e8ef;
        }

        .chatbot-title {
            font-size: 1.3em;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chatbot-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #27ae60;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            background: #27ae60;
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .chat-message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .chat-message.bot {
            flex-direction: row;
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message-avatar.bot {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
        }

        .message-bubble.bot {
            background: white;
            color: #2c3e50;
            border-bottom-left-radius: 4px;
        }

        .message-bubble.user {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e3e8ef;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .chat-send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .chat-send-btn:hover {
            transform: scale(1.05);
        }

        /* ============================================
           COLUMN 3: SOLUTION OUTPUT
           ============================================ */
        .column-3 {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            overflow-y: auto;
        }

        .solution-header {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 3px solid #e3e8ef;
        }

        .solution-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .solution-subtitle {
            color: #7f8c8d;
            font-size: 0.95em;
        }

        .solution-content {
            margin-top: 20px;
        }

        .solution-card {
            background: linear-gradient(to right, #e8f5e9 0%, white 5%);
            border-left: 5px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .solution-card h3 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .solution-card p {
            color: #2c3e50;
            line-height: 1.7;
            margin-bottom: 10px;
        }

        .solution-steps {
            margin-top: 15px;
        }

        .solution-step {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e3e8ef;
        }

        .step-number {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
            color: #2c3e50;
            line-height: 1.6;
        }

        .confidence-indicator {
            display: inline-block;
            padding: 6px 14px;
            background: #4caf50;
            color: white;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
        }

        .empty-solution {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-solution-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- ============================================
             COLUMN 1: CUSTOMER & WORKSITE INFO
             ============================================ -->
        <div class="column-1">
            <!-- Customer Section (Top) -->
            <div class="customer-section">
                <div class="customer-header">
                    <div class="customer-avatar" id="customerAvatar">JD</div>
                    <div class="customer-info">
                        <h2 id="customerName">Jean Dupont</h2>
                        <span class="customer-badge" id="customerLevel">Expert ‚Ä¢ 5 ans</span>
                    </div>
                </div>
                <div class="customer-details">
                    <div class="detail-row">
                        <span class="detail-label">üìç Localisation</span>
                        <span class="detail-value" id="customerLocation">Paris 15√®me</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">üè¢ Chantier assign√©</span>
                        <span class="detail-value" id="assignedWorksite">R√©sidence √âtoile</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">‚è∞ Arriv√©e pr√©vue</span>
                        <span class="detail-value" id="arrivalTime">14:30</span>
                    </div>
                    <div class="detail-row" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e3e8ef;">
                        <span class="detail-label">üìû T√©l√©phone</span>
                        <input type="tel" id="technicianPhone" placeholder="+33612345678"
                               style="padding: 6px 10px; border: 2px solid #e3e8ef; border-radius: 6px; font-size: 0.9em; width: 150px;">
                    </div>
                    <button id="initiateCallBtn" onclick="initiateTwilioCall()"
                            style="width: 100%; margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                        üìû Appeler le Technicien
                    </button>
                    <div id="callStatus" style="margin-top: 10px; padding: 8px; border-radius: 6px; font-size: 0.85em; text-align: center; display: none;"></div>
                </div>
            </div>

            <!-- Worksite Section (Bottom - Larger) -->
            <div class="worksite-section">
                <div class="worksite-header">
                    <div class="worksite-avatar">üè¢</div>
                    <div class="worksite-info">
                        <h3 id="worksiteName">R√©sidence √âtoile</h3>
                        <div class="worksite-meta">
                            <span id="worksiteCustomerSince">Client depuis: 3 ans</span> ‚Ä¢
                            <span id="worksiteInstaller">Installation: M. Bernard</span>
                        </div>
                    </div>
                </div>

                <div class="subscription-badge" id="subscriptionType">
                    Abonnement Premium - 10 Cam√©ras
                </div>

                <div class="equipment-list">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">üì¶ √âquipement install√©</h4>
                    <div class="equipment-item">
                        <span class="equipment-name">üé• Cam√©ra ext√©rieure HD</span>
                        <span class="equipment-qty">6</span>
                    </div>
                    <div class="equipment-item">
                        <span class="equipment-name">üé• Cam√©ra int√©rieure 360¬∞</span>
                        <span class="equipment-qty">4</span>
                    </div>
                    <div class="equipment-item">
                        <span class="equipment-name">üì° Enregistreur NVR</span>
                        <span class="equipment-qty">1</span>
                    </div>
                    <div class="equipment-item">
                        <span class="equipment-name">üîå Alimentation PoE</span>
                        <span class="equipment-qty">2</span>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <div style="font-weight: 600; color: #e65100; margin-bottom: 5px;">‚ÑπÔ∏è Note importante</div>
                    <div style="font-size: 0.9em; color: #2c3e50;">Dernier incident: Probl√®me d'enregistrement r√©solu le 15/10/2025</div>
                </div>
            </div>
        </div>

        <!-- ============================================
             COLUMN 2: CALL CONTROLS & CHATBOT
             ============================================ -->
        <div class="column-2">
            <!-- Call Controls Section (Top) -->
            <div class="call-controls-section">
                <div class="call-status">
                    <div class="call-duration" id="callDuration">00:00</div>
                    <div class="call-state" id="callState">‚óè En ligne</div>
                </div>

                <div class="call-buttons">
                    <button class="call-btn mute" id="muteBtn" onclick="toggleMute()" disabled>
                        üé§
                    </button>
                    <button class="call-btn end-call" id="endCallBtn" onclick="endCall()" disabled>
                        üìû
                    </button>
                </div>

                <div class="audio-waveform" id="waveform">
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                </div>
            </div>

            <!-- Chatbot Section (Bottom - Larger) -->
            <div class="chatbot-section">
                <div class="chatbot-header">
                    <div class="chatbot-title">
                        ü§ñ Assistant IA
                    </div>
                    <div class="chatbot-status">
                        <span class="status-indicator"></span>
                        <span>√âcoute active</span>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message bot">
                        <div class="message-avatar bot">ü§ñ</div>
                        <div class="message-bubble bot">
                            Bonjour! Je vous √©coute et je vais vous aider √† r√©soudre le probl√®me. N'h√©sitez pas √† me poser des questions.
                        </div>
                    </div>
                </div>

                <div class="chat-input-container">
                    <input
                        type="text"
                        class="chat-input"
                        id="chatInput"
                        placeholder="Tapez votre question..."
                        onkeypress="handleChatKeyPress(event)"
                    />
                    <button class="chat-send-btn" onclick="sendChatMessage()">
                        ‚û§
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================
             COLUMN 3: SOLUTION OUTPUT
             ============================================ -->
        <div class="column-3">
            <div class="solution-header">
                <div class="solution-title">
                    ‚úÖ Diagnostic et Solutions
                </div>
                <div class="solution-subtitle">
                    Bas√© sur l'analyse en temps r√©el de la conversation
                </div>
            </div>

            <div class="solution-content" id="solutionContent">
                <div class="empty-solution">
                    <div class="empty-solution-icon">üîç</div>
                    <p>En attente d'informations...</p>
                    <p style="font-size: 0.9em; margin-top: 10px;">Les solutions appara√Ætront ici au fur et √† mesure de la conversation.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let sessionId = null;
        let callSid = null;
        let isMuted = false;
        let callStartTime = null;
        let callTimer = null;
        let suggestionPollingTimer = null;
        let currentLanguage = 'fr';
        let isCallActive = false;
        let statusWebSocket = null;
        let callStatusPoller = null;  // Fallback polling for call status
        let audioContext = null;
        let audioStream = null;
        let twilioDevice = null;  // Twilio Client Device for browser audio
        let activeConnection = null;  // Active Twilio connection

        // Wait for Twilio SDK to load before initializing
        window.addEventListener('load', () => {
            // Check if Twilio SDK is loaded
            if (typeof Twilio === 'undefined') {
                console.error('Twilio SDK not loaded');
                showCallStatus('Erreur: Twilio SDK non charg√©', 'error');

                // Retry after a delay
                setTimeout(() => {
                    if (typeof Twilio !== 'undefined') {
                        initializeSession();
                    } else {
                        showCallStatus('Erreur: Impossible de charger Twilio SDK', 'error');
                    }
                }, 2000);
            } else {
                initializeSession();
            }
        });

        // Initialize session without calling
        async function initializeSession() {
            try {
                // Generate session ID for when call starts
                sessionId = `session-${Date.now()}`;
                console.log('‚úì Session initialized:', sessionId);

                // Initialize Twilio Device for browser-based calling
                await initializeTwilioDevice();

            } catch (error) {
                console.error('Error initializing session:', error);
            }
        }

        // Initialize Twilio Device for browser audio
        async function initializeTwilioDevice() {
            try {
                // Request access token from server
                // Use consistent identity "support-agent" to receive incoming calls
                const response = await fetch('/twilio/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identity: 'support-agent' })
                });

                const data = await response.json();

                if (!data.token) {
                    throw new Error('Failed to get access token');
                }

                // Initialize Twilio Device (SDK 2.x - namespace is Twilio.Device)
                const { Device } = Twilio;
                twilioDevice = new Device(data.token, {
                    codecPreferences: ['opus', 'pcmu'],
                    logLevel: 1  // 0=trace, 1=debug, 2=info, 3=warn, 4=error
                });

                // Register device
                await twilioDevice.register();

                // Setup event listeners (SDK 2.x)
                twilioDevice.on('registered', () => {
                    console.log('‚úì Twilio Device registered');
                    console.log('Device identity:', data.identity);
                    showCallStatus('‚úì En ligne - Pr√™t √† recevoir des appels', 'success');
                });

                twilioDevice.on('error', (error) => {
                    console.error('Twilio Device error:', error);
                    showCallStatus(`Erreur audio: ${error.message}`, 'error');
                });

                twilioDevice.on('incoming', (call) => {
                    const fromNumber = call.parameters.From;
                    console.log('Incoming call from:', fromNumber);
                    showIncomingCallNotification(call, fromNumber);
                });

                twilioDevice.on('tokenWillExpire', async () => {
                    console.log('Token expiring, refreshing...');
                    const response = await fetch('/twilio/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ identity: 'support-agent' })
                    });
                    const refreshData = await response.json();
                    twilioDevice.updateToken(refreshData.token);
                });

                console.log('Twilio Device initialized successfully');

            } catch (error) {
                console.error('Failed to initialize Twilio Device:', error);
                showCallStatus('√âchec d\'initialisation audio', 'error');
            }
        }

        // Show incoming call notification and allow accept/reject
        function showIncomingCallNotification(connection, fromNumber) {
            // Play ringtone (browser notification sound)
            playRingtone();

            // Update UI
            const callStatus = document.getElementById('callStatus');
            callStatus.style.display = 'block';
            callStatus.style.background = '#e3f2fd';
            callStatus.style.color = '#1976d2';
            callStatus.style.padding = '20px';
            callStatus.style.borderRadius = '10px';
            callStatus.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 10px;">üìû</div>
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                        Appel entrant
                    </div>
                    <div style="font-size: 16px; margin-bottom: 20px;">
                        De: ${fromNumber}
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="acceptIncomingCall()"
                                style="padding: 12px 30px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            ‚úì Accepter
                        </button>
                        <button onclick="rejectIncomingCall()"
                                style="padding: 12px 30px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            ‚úó Refuser
                        </button>
                    </div>
                </div>
            `;

            // Store connection for accept/reject
            window.incomingConnection = connection;
        }

        // Accept incoming call (SDK 2.x)
        function acceptIncomingCall() {
            if (window.incomingConnection) {
                console.log('Accepting incoming call');
                const call = window.incomingConnection;
                call.accept();
                stopRingtone();

                // Store as active connection
                activeConnection = call;
                isCallActive = true;

                // Update customer name with caller number
                const fromNumber = call.parameters.From;
                document.getElementById('customerName').textContent = fromNumber;

                // Setup call event listeners
                call.on('accept', () => {
                    console.log('Call accepted');
                    // Start call timer
                    callStartTime = Date.now();
                    callTimer = setInterval(updateCallDuration, 1000);

                    // Start polling for suggestions
                    startSuggestionPolling();

                    // Update UI
                    document.getElementById('callState').textContent = '‚óè Appel en cours';
                    document.getElementById('muteBtn').disabled = false;
                    document.getElementById('endCallBtn').disabled = false;
                    document.getElementById('initiateCallBtn').disabled = true;
                    showCallStatus('Appel connect√© - Conversation en cours', 'success');
                });

                call.on('disconnect', () => {
                    console.log('Call disconnected');
                    handleRemoteCallTermination({ status: 'completed' });
                });

                window.incomingConnection = null;
            }
        }

        // Reject incoming call
        function rejectIncomingCall() {
            if (window.incomingConnection) {
                console.log('Rejecting incoming call');
                window.incomingConnection.reject();
                stopRingtone();
                showCallStatus('Appel refus√©', 'progress');
                window.incomingConnection = null;

                // Hide notification after 3 seconds
                setTimeout(() => {
                    document.getElementById('callStatus').style.display = 'none';
                }, 3000);
            }
        }

        // Ringtone functions
        let ringtoneAudio = null;
        function playRingtone() {
            // Use browser's built-in beep or create audio context
            try {
                // Simple beep using Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 440; // A4 note
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);

                oscillator.start();

                // Ring pattern: beep for 0.5s, pause 0.5s, repeat
                ringtoneAudio = {
                    context: audioContext,
                    oscillator: oscillator,
                    interval: setInterval(() => {
                        oscillator.stop();
                        const newOsc = audioContext.createOscillator();
                        newOsc.connect(gainNode);
                        newOsc.frequency.value = 440;
                        newOsc.start();
                        oscillator = newOsc;
                    }, 1000)
                };
            } catch (e) {
                console.error('Failed to play ringtone:', e);
            }
        }

        function stopRingtone() {
            if (ringtoneAudio) {
                try {
                    ringtoneAudio.oscillator.stop();
                    clearInterval(ringtoneAudio.interval);
                    ringtoneAudio.context.close();
                    ringtoneAudio = null;
                } catch (e) {
                    console.error('Failed to stop ringtone:', e);
                }
            }
        }

        // Initiate Twilio call
        async function initiateTwilioCall() {
            const phoneNumber = document.getElementById('technicianPhone').value.trim();
            const technicianName = document.getElementById('customerName').textContent;
            const technicianId = 'TECH' + Date.now();

            // Validate phone number
            if (!phoneNumber) {
                showCallStatus('Veuillez entrer un num√©ro de t√©l√©phone', 'error');
                return;
            }

            if (!phoneNumber.startsWith('+')) {
                showCallStatus('Le num√©ro doit commencer par + (format international)', 'error');
                return;
            }

            try {
                // Disable button and show progress
                document.getElementById('initiateCallBtn').disabled = true;
                document.getElementById('initiateCallBtn').textContent = 'üìû Appel en cours...';
                showCallStatus('Initiation de l\'appel via navigateur...', 'progress');

                // Check if Twilio Device is ready (SDK 1.x)
                if (!twilioDevice || twilioDevice.status() !== 'ready') {
                    throw new Error('Twilio Device n\'est pas pr√™t. Rechargez la page.');
                }

                // Make call through browser using Twilio Device (SDK 1.x)
                const params = {
                    To: phoneNumber
                };

                // Connect call - SDK 1.x
                activeConnection = twilioDevice.connect(params);
                isCallActive = true;

                // Start call timer
                callStartTime = Date.now();
                callTimer = setInterval(updateCallDuration, 1000);

                // Start polling for transcriptions/suggestions
                startSuggestionPolling();

                // Update UI
                document.getElementById('initiateCallBtn').textContent = '‚úì Appel connect√©';
                showCallStatus('Appel connect√© - Vous pouvez parler', 'success');

                console.log('‚úì Browser call initiated to:', phoneNumber);

            } catch (error) {
                console.error('Error initiating call:', error);
                showCallStatus(`Erreur: ${error.message}`, 'error');
                document.getElementById('initiateCallBtn').disabled = false;
                document.getElementById('initiateCallBtn').textContent = 'üìû Appeler le Technicien';
            }
        }

        // Show call status message
        function showCallStatus(message, type) {
            const statusDiv = document.getElementById('callStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;

            // Set color based on type
            if (type === 'success') {
                statusDiv.style.background = '#e8f5e9';
                statusDiv.style.color = '#2e7d32';
            } else if (type === 'error') {
                statusDiv.style.background = '#ffebee';
                statusDiv.style.color = '#c62828';
            } else if (type === 'progress') {
                statusDiv.style.background = '#fff3e0';
                statusDiv.style.color = '#e65100';
            }
        }

        // Poll Twilio call status to detect when customer hangs up
        function startCallStatusPolling() {
            if (callStatusPoller) {
                clearInterval(callStatusPoller);
            }

            callStatusPoller = setInterval(async () => {
                if (!callSid || !isCallActive) return;

                try {
                    const response = await fetch(`/twilio/call-status/${callSid}`);
                    const data = await response.json();

                    console.log('Call status:', data.status);

                    // Check if call has ended
                    if (data.status && ['completed', 'failed', 'busy', 'no-answer', 'canceled'].includes(data.status)) {
                        console.log('Call ended on Twilio side:', data.status);
                        handleRemoteCallTermination({ status: data.status });
                    }
                } catch (error) {
                    console.error('Error checking call status:', error);
                }
            }, 2000); // Check every 2 seconds
        }

        // Handle call termination from customer side
        function handleRemoteCallTermination(data) {
            if (!isCallActive) return; // Already ended

            // Stop all timers and polling
            isCallActive = false;
            clearInterval(callTimer);
            clearInterval(suggestionPollingTimer);
            clearInterval(callStatusPoller);

            // Update UI
            document.getElementById('callState').textContent = '‚óã Appel termin√©';
            document.getElementById('muteBtn').disabled = true;
            document.getElementById('endCallBtn').disabled = true;
            document.getElementById('initiateCallBtn').disabled = false;
            document.getElementById('initiateCallBtn').textContent = 'üìû Appeler le Technicien';

            // Show termination message
            const statusMessages = {
                'completed': 'Le client a raccroch√©',
                'failed': 'Appel √©chou√©',
                'busy': 'Ligne occup√©e',
                'no-answer': 'Pas de r√©ponse',
                'canceled': 'Appel annul√©'
            };
            const reason = statusMessages[data.status] || `Appel termin√©: ${data.status}`;
            showCallStatus(reason, 'progress');

            // Add system message to chat
            const duration = document.getElementById('callDuration').textContent;
            addChatMessage(`Appel termin√©. Dur√©e: ${duration}`, 'system');

            console.log('Call terminated by customer:', data);
        }

        // Start polling for suggestions/transcriptions
        function startSuggestionPolling() {
            suggestionPollingTimer = setInterval(async () => {
                if (!sessionId || !isCallActive) return;

                try {
                    const response = await fetch(`/demo/get-session-suggestions?session_id=${sessionId}&limit=20`);

                    if (response.ok) {
                        const data = await response.json();

                        if (data.suggestions && data.suggestions.length > 0) {
                            displaySolutions(data.suggestions);

                            // Show clarification questions in chat
                            const questions = data.suggestions.filter(s => s.type === 'clarification_question');
                            questions.forEach((q, index) => {
                                // Only show new questions (not already in chat)
                                if (!document.querySelector(`[data-suggestion-id="${q.id}"]`)) {
                                    setTimeout(() => {
                                        addChatMessage(q.content, 'bot', q.id);
                                    }, index * 500);
                                }
                            });
                        }
                    }

                } catch (error) {
                    console.error('Error polling suggestions:', error);
                }
            }, 3000); // Poll every 3 seconds
        }

        // Update call duration display
        function updateCallDuration() {
            if (!callStartTime) return;

            const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;

            document.getElementById('callDuration').textContent =
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Toggle mute
        function toggleMute() {
            if (!activeConnection) return;

            isMuted = !isMuted;
            const muteBtn = document.getElementById('muteBtn');

            // Mute/unmute the Twilio connection
            activeConnection.mute(isMuted);

            if (isMuted) {
                muteBtn.classList.add('active');
                muteBtn.textContent = 'üîá';
                document.getElementById('callState').textContent = '‚óè En sourdine';
            } else {
                muteBtn.classList.remove('active');
                muteBtn.textContent = 'üé§';
                document.getElementById('callState').textContent = '‚óè En ligne';
            }
        }

        // End call
        async function endCall() {
            if (!confirm('Voulez-vous vraiment terminer l\'appel?')) {
                return;
            }

            isCallActive = false;

            // Stop all timers and polling
            if (callTimer) {
                clearInterval(callTimer);
            }
            if (suggestionPollingTimer) {
                clearInterval(suggestionPollingTimer);
            }
            if (callStatusPoller) {
                clearInterval(callStatusPoller);
            }

            // Disconnect Twilio Device connection
            if (activeConnection) {
                try {
                    showCallStatus('Fin de l\'appel...', 'progress');

                    // Disconnect the call
                    activeConnection.disconnect();
                    activeConnection = null;

                    const response = await fetch('/twilio/end-call', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            call_sid: callSid,
                            session_id: sessionId
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showCallStatus('Appel termin√©', 'success');
                        console.log('‚úì Call ended:', data);

                        // Show statistics if available
                        if (data.session_stats) {
                            console.log('Session statistics:', data.session_stats);
                        }
                    }

                } catch (error) {
                    console.error('Error ending call:', error);
                    showCallStatus(`Erreur: ${error.message}`, 'error');
                }
            }

            // Update UI
            document.getElementById('callState').textContent = '‚óè Termin√©';
            document.getElementById('endCallBtn').disabled = true;
            document.getElementById('initiateCallBtn').disabled = false;
            document.getElementById('initiateCallBtn').textContent = 'üìû Appeler le Technicien';

            // Reset state
            callSid = null;
            callStartTime = null;
        }

        // Chat functionality
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message || !sessionId) return;

            // Add user message to chat
            addChatMessage(message, 'user');
            input.value = '';

            // Send to backend
            try {
                const response = await fetch('/demo/send-demo-transcription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        speaker: 'customer',
                        text: message,
                        start_time: (Date.now() - callStartTime) / 1000,
                        end_time: (Date.now() - callStartTime) / 1000,
                        confidence: 1.0,
                        language: currentLanguage
                    })
                });

                const data = await response.json();

                // Update solutions
                if (data.suggestions && data.suggestions.length > 0) {
                    displaySolutions(data.suggestions);
                }

                // Show bot response in chat if there are clarification questions
                const questions = data.suggestions.filter(s => s.type === 'clarification_question');
                if (questions.length > 0) {
                    setTimeout(() => {
                        addChatMessage(questions[0].content, 'bot');
                    }, 500);
                }

            } catch (error) {
                console.error('Error sending message:', error);
                addChatMessage('Erreur de communication avec le serveur.', 'bot');
            }
        }

        function addChatMessage(text, sender, suggestionId = null) {
            const messagesDiv = document.getElementById('chatMessages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;

            // Add data attribute for tracking
            if (suggestionId) {
                messageDiv.setAttribute('data-suggestion-id', suggestionId);
            }

            const avatarDiv = document.createElement('div');
            avatarDiv.className = `message-avatar ${sender}`;
            // Different avatars for different senders
            if (sender === 'bot') {
                avatarDiv.textContent = 'ü§ñ';
            } else if (sender === 'system') {
                avatarDiv.textContent = '‚ÑπÔ∏è';
            } else {
                avatarDiv.textContent = 'üë§';
            }

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `message-bubble ${sender}`;
            bubbleDiv.textContent = text;

            // System messages have different styling
            if (sender === 'system') {
                bubbleDiv.style.background = '#f5f5f5';
                bubbleDiv.style.color = '#666';
                bubbleDiv.style.fontStyle = 'italic';
            }

            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(bubbleDiv);

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function displaySolutions(suggestions) {
            const solutionContent = document.getElementById('solutionContent');

            // Filter knowledge base solutions
            const solutions = suggestions.filter(s => s.type === 'knowledge_base');

            if (solutions.length === 0) return;

            // Clear empty state
            solutionContent.innerHTML = '';

            solutions.forEach(solution => {
                const card = document.createElement('div');
                card.className = 'solution-card';

                card.innerHTML = `
                    <h3>${solution.title}</h3>
                    <p>${solution.content}</p>
                    ${solution.confidence ?
                        `<span class="confidence-indicator">Confiance: ${(solution.confidence * 100).toFixed(0)}%</span>`
                        : ''}
                `;

                solutionContent.insertBefore(card, solutionContent.firstChild);
            });
        }
    </script>
</body>
</html>
