<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Technicien | Service Cloud</title>
    <script src="https://unpkg.com/@twilio/voice-sdk@2.11.0/dist/twilio.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --sf-blue: #0176d3;
            --sf-blue-dark: #014486;
            --sf-blue-light: #1b96ff;
            --sf-nav-blue: #032d60;
            --sf-white: #ffffff;
            --sf-gray-1: #f3f3f3;
            --sf-gray-2: #e5e5e5;
            --sf-gray-3: #c9c9c9;
            --sf-gray-4: #969492;
            --sf-text: #181818;
            --sf-text-secondary: #444444;
            --sf-text-muted: #706e6b;
            --sf-success: #2e844a;
            --sf-success-light: #cdefc4;
            --sf-warning: #dd7a01;
            --sf-error: #ba0517;
            --sf-border: #e5e5e5;
            --sf-card-shadow: 0 2px 2px rgba(0,0,0,0.1);
            --sf-border-radius: 0.25rem;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--sf-gray-1);
            height: 100vh;
            overflow: hidden;
            color: var(--sf-text);
            font-size: 13px;
        }

        .global-header {
            background: var(--sf-nav-blue);
            height: 45px;
            display: flex;
            align-items: center;
            padding: 0 1rem;
            gap: 1rem;
        }

        .sf-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--sf-white);
            font-weight: 700;
            font-size: 16px;
        }

        .sf-logo-icon {
            width: 28px;
            height: 28px;
            background: var(--sf-white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-search {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .header-search input {
            width: 100%;
            padding: 6px 12px 6px 36px;
            border: none;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            color: var(--sf-white);
            font-size: 13px;
        }

        .header-search input::placeholder { color: rgba(255,255,255,0.6); }

        .header-search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255,255,255,0.6);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: auto;
        }

        .header-btn {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: var(--sf-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .header-btn:hover { background: rgba(255,255,255,0.1); }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--sf-blue-light);
            color: var(--sf-white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
        }

        .page-header {
            background: var(--sf-white);
            border-bottom: 1px solid var(--sf-border);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #7f8de1 0%, #5867e8 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--sf-white);
            font-size: 18px;
        }

        .page-title-group { flex: 1; }

        .page-pretitle {
            font-size: 11px;
            color: var(--sf-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .page-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--sf-text);
        }

        .page-actions { display: flex; gap: 8px; }

        .sf-btn {
            padding: 8px 16px;
            border-radius: var(--sf-border-radius);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
            border: 1px solid transparent;
        }

        .sf-btn-neutral {
            background: var(--sf-white);
            border-color: var(--sf-gray-3);
            color: var(--sf-text);
        }

        .sf-btn-neutral:hover { background: var(--sf-gray-1); }

        .sf-btn-success {
            background: var(--sf-success);
            color: var(--sf-white);
        }

        .sf-btn-success:hover { background: #236b3b; }

        .sf-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .main-container {
            display: grid;
            grid-template-columns: 300px 380px 1fr;
            height: calc(100vh - 45px - 57px);
            gap: 1rem;
            padding: 1rem;
            overflow: hidden;
        }

        .sf-card {
            background: var(--sf-white);
            border-radius: var(--sf-border-radius);
            box-shadow: var(--sf-card-shadow);
            border: 1px solid var(--sf-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sf-card-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--sf-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--sf-white);
            flex-shrink: 0;
        }

        .sf-card-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--sf-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sf-card-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #7f8de1 0%, #5867e8 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--sf-white);
            font-size: 12px;
        }

        .sf-card-body {
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
        }

        .column-1 {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow: hidden;
        }

        .record-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--sf-border);
            margin-bottom: 1rem;
        }

        .record-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7f8de1 0%, #5867e8 100%);
            color: var(--sf-white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
        }

        .record-info h2 {
            font-size: 16px;
            font-weight: 700;
            color: var(--sf-text);
            margin-bottom: 2px;
        }

        .record-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--sf-success-light);
            color: var(--sf-success);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .detail-list { display: flex; flex-direction: column; gap: 12px; }

        .detail-item { display: flex; flex-direction: column; gap: 2px; }

        .detail-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--sf-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value { font-size: 13px; color: var(--sf-text); }
        .detail-value a { color: var(--sf-blue); text-decoration: none; }
        .detail-value a:hover { text-decoration: underline; }

        .phone-input-group {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--sf-border);
        }

        .phone-input-row {
            display: flex;
            gap: 8px;
        }

        .phone-input-row .sf-input {
            flex: 1;
        }

        .call-btn-inline {
            width: 36px;
            height: 36px;
            background: var(--sf-success);
            color: var(--sf-white);
            border: none;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .call-btn-inline:hover { background: #236b3b; }
        .call-btn-inline:disabled { opacity: 0.5; cursor: not-allowed; }

        .sf-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--sf-gray-3);
            border-radius: var(--sf-border-radius);
            font-size: 13px;
            font-family: inherit;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .sf-input:focus {
            outline: none;
            border-color: var(--sf-blue);
            box-shadow: 0 0 3px var(--sf-blue);
        }

        .input-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--sf-text-muted);
            margin-bottom: 4px;
        }

        .call-status {
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: var(--sf-border-radius);
            font-size: 12px;
            display: none;
        }

        .call-status.success { background: #cdefc4; color: var(--sf-success); }
        .call-status.error { background: #fdd; color: var(--sf-error); }
        .call-status.progress { background: #fef3cd; color: var(--sf-warning); }

        .related-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--sf-gray-2);
        }

        .related-item:last-child { border-bottom: none; }

        .related-item-name {
            font-size: 13px;
            color: var(--sf-blue);
            cursor: pointer;
        }

        .related-item-name:hover { text-decoration: underline; }

        .related-item-qty {
            background: var(--sf-gray-1);
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            color: var(--sf-text-secondary);
        }

        .column-2 {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow: hidden;
        }

        .transcription-content { flex: 1; overflow-y: auto; padding: 0; }

        .transcription-empty {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--sf-text-muted);
            padding: 2rem;
            text-align: center;
        }

        .transcription-empty-icon { font-size: 32px; margin-bottom: 8px; opacity: 0.5; }

        .transcript-line { padding: 10px 1rem; border-bottom: 1px solid var(--sf-gray-2); }
        .transcript-line:last-child { border-bottom: none; }

        .transcript-speaker {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .transcript-line.agent .transcript-speaker { color: var(--sf-blue); }
        .transcript-line.technician .transcript-speaker { color: var(--sf-success); }

        .transcript-text { font-size: 13px; color: var(--sf-text); line-height: 1.5; }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--sf-gray-1);
            border-radius: 4px;
            font-size: 12px;
            color: var(--sf-text-muted);
        }

        .status-badge.active { background: var(--sf-success-light); color: var(--sf-success); }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--sf-gray-4); }
        .status-badge.active .status-dot { background: var(--sf-success); animation: pulse 2s infinite; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .chat-messages { flex: 1; overflow-y: auto; padding: 0; }

        .chat-message { padding: 10px 1rem; display: flex; gap: 10px; }
        .chat-message.user { flex-direction: row-reverse; background: var(--sf-gray-1); }

        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
            background: var(--sf-gray-2);
        }

        .chat-message.bot .message-avatar {
            background: linear-gradient(135deg, #7f8de1 0%, #5867e8 100%);
            color: var(--sf-white);
        }

        .message-bubble { flex: 1; font-size: 13px; line-height: 1.5; color: var(--sf-text); }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid var(--sf-border);
            display: flex;
            gap: 8px;
            background: var(--sf-gray-1);
        }

        .chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--sf-gray-3);
            border-radius: var(--sf-border-radius);
            font-size: 13px;
            font-family: inherit;
            background: var(--sf-white);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--sf-blue);
            box-shadow: 0 0 3px var(--sf-blue);
        }

        .chat-send-btn {
            padding: 8px 16px;
            background: var(--sf-blue);
            color: var(--sf-white);
            border: none;
            border-radius: var(--sf-border-radius);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        .chat-send-btn:hover { background: var(--sf-blue-dark); }

        .solutions-content { flex: 1; overflow-y: auto; padding: 0; }

        .empty-solution {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--sf-text-muted);
            text-align: center;
            padding: 2rem;
        }

        .empty-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.4; }

        .solution-card { padding: 1rem; border-bottom: 1px solid var(--sf-border); }
        .solution-card:last-child { border-bottom: none; }

        .solution-card h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--sf-blue);
            margin-bottom: 8px;
            cursor: pointer;
        }

        .solution-card h3:hover { text-decoration: underline; }

        .solution-card p {
            font-size: 13px;
            line-height: 1.6;
            color: var(--sf-text-secondary);
            margin-bottom: 10px;
        }

        .confidence-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--sf-success-light);
            color: var(--sf-success);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .hidden-controls { display: none; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--sf-gray-1); }
        ::-webkit-scrollbar-thumb { background: var(--sf-gray-3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--sf-gray-4); }

        @media (max-width: 1200px) { .main-container { grid-template-columns: 280px 340px 1fr; } }
        @media (max-width: 1024px) {
            .main-container { grid-template-columns: 1fr; height: auto; overflow-y: auto; }
            body { overflow-y: auto; }
            .sf-card { min-height: 350px; }
        }
    </style>
</head>
<body>
    <header class="global-header">
        <div class="sf-logo">
            <div class="sf-logo-icon">‚òÅÔ∏è</div>
            Service Cloud
        </div>
        <div class="header-search">
            <span class="header-search-icon">üîç</span>
            <input type="text" placeholder="Search...">
        </div>
        <div class="header-actions">
            <button class="header-btn">üîî</button>
            <button class="header-btn">‚öôÔ∏è</button>
            <div class="user-avatar">AG</div>
        </div>
    </header>

    <div class="page-header">
        <div class="page-icon">üìû</div>
        <div class="page-title-group">
            <div class="page-pretitle">Support Technique</div>
            <div class="page-title">Console Service</div>
        </div>
        <div class="page-actions"></div>
    </div>

    <div class="main-container">
        <div class="column-1">
            <div class="sf-card" style="flex: 0 0 auto;">
                <div class="sf-card-header">
                    <div class="sf-card-title"><span class="sf-card-icon">üë§</span>Contact</div>
                </div>
                <div class="sf-card-body">
                    <div class="record-header">
                        <div class="record-avatar" id="customerAvatar">JD</div>
                        <div class="record-info">
                            <h2 id="customerName">Jean Dupont</h2>
                            <span class="record-badge" id="customerLevel">‚úì Expert ¬∑ 5 ans</span>
                        </div>
                    </div>
                    <div class="detail-list">
                        <div class="detail-item">
                            <span class="detail-label">Localisation</span>
                            <span class="detail-value" id="customerLocation">Paris 15√®me</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Chantier Assign√©</span>
                            <span class="detail-value"><a href="#" id="assignedWorksite">R√©sidence √âtoile</a></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Arriv√©e Pr√©vue</span>
                            <span class="detail-value" id="arrivalTime">14:30</span>
                        </div>
                    </div>
                    <div class="phone-input-group">
                        <label class="input-label">T√©l√©phone</label>
                        <div class="phone-input-row">
                            <input type="tel" id="technicianPhone" class="sf-input" placeholder="+33 6 12 34 56 78">
                            <button class="call-btn-inline" id="initiateCallBtn" onclick="initiateTwilioCall()" title="Appeler">üìû</button>
                        </div>
                        <div id="callStatus" class="call-status"></div>
                    </div>
                </div>
            </div>

            <div class="sf-card" style="flex: 1; min-height: 0;">
                <div class="sf-card-header">
                    <div class="sf-card-title"><span class="sf-card-icon">üè¢</span>Compte</div>
                </div>
                <div class="sf-card-body">
                    <div class="detail-list">
                        <div class="detail-item">
                            <span class="detail-label">Nom du Compte</span>
                            <span class="detail-value"><a href="#" id="worksiteName">R√©sidence √âtoile</a></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Client Depuis</span>
                            <span class="detail-value" id="worksiteCustomerSince">3 ans</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Abonnement</span>
                            <span class="detail-value" id="subscriptionType">Premium - 10 Cam√©ras</span>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--sf-border);">
                        <div class="detail-label" style="margin-bottom: 8px;">√âquipements (4)</div>
                        <div class="related-item"><span class="related-item-name">Cam√©ra ext√©rieure HD</span><span class="related-item-qty">6</span></div>
                        <div class="related-item"><span class="related-item-name">Cam√©ra int√©rieure 360¬∞</span><span class="related-item-qty">4</span></div>
                        <div class="related-item"><span class="related-item-name">Enregistreur NVR</span><span class="related-item-qty">1</span></div>
                        <div class="related-item"><span class="related-item-name">Alimentation PoE</span><span class="related-item-qty">2</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="column-2">
            <div class="sf-card" style="flex: 1; min-height: 0;">
                <div class="sf-card-header">
                    <div class="sf-card-title"><span class="sf-card-icon">üéôÔ∏è</span>Transcription</div>
                    <div class="status-badge" id="transcriptionBadge">
                        <span class="status-dot" id="statusDot"></span>
                        <span id="transcriptionStatus">Inactif</span>
                    </div>
                </div>
                <div class="sf-card-body transcription-content" id="transcriptionContent">
                    <div class="transcription-empty">
                        <div class="transcription-empty-icon">üéß</div>
                        <div>La transcription appara√Ætra ici pendant l'appel</div>
                    </div>
                </div>
            </div>

            <div class="sf-card" style="flex: 1; min-height: 0;">
                <div class="sf-card-header">
                    <div class="sf-card-title"><span class="sf-card-icon">ü§ñ</span>Einstein Assistant</div>
                    <div class="status-badge active"><span class="status-dot"></span><span>En ligne</span></div>
                </div>
                <div class="sf-card-body chat-messages" id="chatMessages">
                    <div class="chat-message bot">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-bubble">Bonjour! Je suis Einstein, votre assistant IA. Je vais analyser la conversation et vous sugg√©rer des solutions.</div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Posez une question..." onkeypress="handleChatKeyPress(event)">
                    <button class="chat-send-btn" onclick="sendChatMessage()">Envoyer</button>
                </div>
            </div>
        </div>

        <div class="sf-card">
            <div class="sf-card-header">
                <div class="sf-card-title"><span class="sf-card-icon">üí°</span>Articles de Connaissance</div>
            </div>
            <div class="sf-card-body solutions-content" id="solutionContent">
                <div class="empty-solution">
                    <div class="empty-icon">üìö</div>
                    <div style="font-weight: 600; margin-bottom: 4px;">Aucune suggestion</div>
                    <div style="font-size: 12px;">Les articles pertinents appara√Ætront ici</div>
                </div>
            </div>
        </div>
    </div>

    <div class="hidden-controls">
        <button id="muteBtn"></button>
        <button id="endCallBtn"></button>
    </div>

    <script>
        let sessionId = null, callSid = null, isMuted = false, callStartTime = null, callTimer = null;
        let suggestionPollingTimer = null, currentLanguage = 'fr', isCallActive = false, callStatusPoller = null;
        let twilioDevice = null, activeConnection = null, transcriptionEnabledByUser = true;
        let agentAudioContext = null, agentAudioWorkletNode = null, agentAudioWebSocket = null;
        let agentMediaStream = null, isAgentAudioMuted = false;
        let suggestionsWebSocket = null, technicianTranscriptionWebSocket = null;

        window.addEventListener('load', () => {
            if (typeof Twilio === 'undefined') { showCallStatus('Erreur: Twilio SDK', 'error'); setTimeout(() => { if (typeof Twilio !== 'undefined') initializeSession(); }, 2000); }
            else initializeSession();
        });

        async function initializeSession() {
            try {
                sessionId = `session-${Date.now()}`;
                await fetch('/twilio/start-session', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: sessionId, technician_name: document.getElementById('customerName')?.textContent || 'Technicien', agent_name: 'Agent Support' }) });
                await initializeTwilioDevice();
            } catch (e) { console.error(e); }
        }

        async function initializeTwilioDevice() {
            try {
                const response = await fetch('/twilio/token', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ identity: 'support-agent' }) });
                const data = await response.json();
                if (!data.token) throw new Error('No token');
                const { Device } = Twilio;
                twilioDevice = new Device(data.token, { codecPreferences: ['opus', 'pcmu'], logLevel: 1 });
                await twilioDevice.register();
                twilioDevice.on('registered', () => showCallStatus('Pr√™t', 'success'));
                twilioDevice.on('error', (e) => showCallStatus(`Erreur: ${e.message}`, 'error'));
                twilioDevice.on('incoming', (call) => showIncomingCallNotification(call, call.parameters.From));
                twilioDevice.on('tokenWillExpire', async () => { const r = await fetch('/twilio/token', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ identity: 'support-agent' }) }); twilioDevice.updateToken((await r.json()).token); });
            } catch (e) { showCallStatus('√âchec init', 'error'); }
        }

        function showIncomingCallNotification(conn, from) {
            const s = document.getElementById('callStatus');
            s.style.display = 'block'; s.className = 'call-status progress';
            s.innerHTML = `Appel: ${from}<br><button onclick="acceptIncomingCall()" class="sf-btn sf-btn-success" style="margin-top:8px;margin-right:8px;">Accepter</button><button onclick="rejectIncomingCall()" class="sf-btn sf-btn-neutral">Refuser</button>`;
            window.incomingConnection = conn;
        }

        function acceptIncomingCall() {
            if (window.incomingConnection) {
                const call = window.incomingConnection; call.accept(); activeConnection = call; isCallActive = true;
                document.getElementById('customerName').textContent = call.parameters.From;
                call.on('accept', () => { callStartTime = Date.now(); callTimer = setInterval(updateCallDuration, 1000); document.getElementById('initiateCallBtn').disabled = true; showCallStatus('Connect√©', 'success'); document.getElementById('statusDot').classList.add('active'); document.getElementById('transcriptionBadge').classList.add('active'); document.getElementById('transcriptionStatus').textContent = 'En cours'; setTimeout(() => { if (isCallActive && transcriptionEnabledByUser) startTranscription(); startSuggestionPolling(); }, 2000); });
                call.on('disconnect', () => handleRemoteCallTermination({ status: 'completed' }));
                window.incomingConnection = null;
            }
        }

        function rejectIncomingCall() { if (window.incomingConnection) { window.incomingConnection.reject(); showCallStatus('Refus√©', 'progress'); window.incomingConnection = null; setTimeout(() => document.getElementById('callStatus').style.display = 'none', 3000); } }

        async function initiateTwilioCall() {
            const phone = document.getElementById('technicianPhone').value.trim();
            if (!phone) { showCallStatus('Entrez un num√©ro', 'error'); return; }
            if (!phone.startsWith('+')) { showCallStatus('Format: +33...', 'error'); return; }
            try {
                document.getElementById('initiateCallBtn').disabled = true;
                showCallStatus('Connexion...', 'progress');
                if (!twilioDevice || twilioDevice.state !== 'registered') throw new Error('Twilio non pr√™t');
                await connectTranscriptionWebSockets();
                const call = await twilioDevice.connect({ params: { To: phone, session_id: sessionId } });
                activeConnection = call; isCallActive = true;
                call.on('accept', () => { callStartTime = Date.now(); callTimer = setInterval(updateCallDuration, 1000); showCallStatus('Connect√©', 'success'); document.getElementById('statusDot').classList.add('active'); document.getElementById('transcriptionBadge').classList.add('active'); document.getElementById('transcriptionStatus').textContent = 'En cours'; setTimeout(() => { if (isCallActive && transcriptionEnabledByUser) startTranscription(); startSuggestionPolling(); }, 2000); });
                call.on('disconnect', () => handleRemoteCallTermination({ status: 'completed' }));
                call.on('error', (e) => { showCallStatus(`Erreur: ${e.message}`, 'error'); handleRemoteCallTermination({ status: 'failed' }); });
            } catch (e) { showCallStatus(`Erreur: ${e.message}`, 'error'); document.getElementById('initiateCallBtn').disabled = false; }
        }

        function showCallStatus(msg, type) { const s = document.getElementById('callStatus'); s.style.display = 'block'; s.textContent = msg; s.className = `call-status ${type}`; }

        function handleRemoteCallTermination(data) {
            if (!isCallActive) return; isCallActive = false; clearInterval(callTimer); clearInterval(suggestionPollingTimer); clearInterval(callStatusPoller);
            document.getElementById('initiateCallBtn').disabled = false;
            document.getElementById('statusDot').classList.remove('active');
            document.getElementById('transcriptionBadge').classList.remove('active'); document.getElementById('transcriptionStatus').textContent = 'Inactif';
            showCallStatus({ completed: 'Termin√©', failed: '√âchec', busy: 'Occup√©', 'no-answer': 'Pas de r√©ponse', canceled: 'Annul√©' }[data.status] || 'Termin√©', 'progress');
        }

        function startSuggestionsWebSocket() {
            const ws = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            suggestionsWebSocket = new WebSocket(`${ws}//${window.location.host}/demo/suggestions-stream/${sessionId}`);
            suggestionsWebSocket.onmessage = (e) => { try { const d = JSON.parse(e.data); if (d.type === 'suggestion' || d.type === 'knowledge_base') displaySolutions([d]); else if (d.type === 'clarification_question' && !document.querySelector(`[data-suggestion-id="${d.id}"]`)) addChatMessage(d.content, 'bot', d.id); else if (d.type === 'suggestions_batch' && d.suggestions?.length) displaySolutions(d.suggestions); } catch {} };
            suggestionsWebSocket.onerror = () => startSuggestionPollingFallback();
        }

        function startSuggestionPollingFallback() { if (suggestionPollingTimer) return; suggestionPollingTimer = setInterval(async () => { if (!sessionId || !isCallActive) return; try { const r = await fetch(`/demo/get-session-suggestions?session_id=${sessionId}&limit=20`); if (r.ok) { const d = await r.json(); if (d.suggestions?.length) displaySolutions(d.suggestions); } } catch {} }, 3000); }

        function startSuggestionPolling() { startSuggestionsWebSocket(); }

        function updateCallDuration() { if (!callStartTime) return; const e = Math.floor((Date.now() - callStartTime) / 1000); const d = document.getElementById('callDuration'); d.textContent = `${String(Math.floor(e / 60)).padStart(2, '0')}:${String(e % 60).padStart(2, '0')}`; d.style.display = 'inline'; }

        function handleChatKeyPress(e) { if (e.key === 'Enter') sendChatMessage(); }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput'), msg = input.value.trim();
            if (!msg || !sessionId) return; addChatMessage(msg, 'user'); input.value = '';
            try {
                const r = await fetch('/demo/send-demo-transcription', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: sessionId, speaker: 'customer', text: msg, start_time: (Date.now() - callStartTime) / 1000, end_time: (Date.now() - callStartTime) / 1000, confidence: 1.0, language: currentLanguage }) });
                const d = await r.json();
                if (d.suggestions?.length) { displaySolutions(d.suggestions); const q = d.suggestions.filter(s => s.type === 'clarification_question'); if (q.length) setTimeout(() => addChatMessage(q[0].content, 'bot'), 500); }
            } catch { addChatMessage('Erreur de communication.', 'bot'); }
        }

        function addChatMessage(text, sender, suggestionId = null) {
            const m = document.getElementById('chatMessages'), div = document.createElement('div');
            div.className = `chat-message ${sender}`; if (suggestionId) div.setAttribute('data-suggestion-id', suggestionId);
            div.innerHTML = `<div class="message-avatar">${sender === 'bot' ? 'ü§ñ' : 'üë§'}</div><div class="message-bubble">${text}</div>`;
            m.appendChild(div); m.scrollTop = m.scrollHeight;
        }

        const audioWorkletCode = `class AudioStreamProcessor extends AudioWorkletProcessor { constructor() { super(); this.bufferSize = 4096; this.buffer = new Float32Array(this.bufferSize); this.bufferIndex = 0; } process(inputs) { const input = inputs[0]; if (!input || !input[0]) return true; const ch = input[0]; for (let i = 0; i < ch.length; i++) { this.buffer[this.bufferIndex++] = ch[i]; if (this.bufferIndex >= this.bufferSize) { this.port.postMessage({ type: 'audio', buffer: this.buffer.slice() }); this.bufferIndex = 0; } } return true; } } registerProcessor('audio-stream-processor', AudioStreamProcessor);`;

        async function connectTranscriptionWebSockets() {
            return new Promise((resolve) => {
                const ws = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                technicianTranscriptionWebSocket = new WebSocket(`${ws}//${window.location.host}/twilio/technician-transcription/${sessionId}`);
                agentAudioWebSocket = new WebSocket(`${ws}//${window.location.host}/twilio/agent-audio-stream/${sessionId}`);
                let t = false, a = false; const check = () => { if (t && a) resolve(); };
                technicianTranscriptionWebSocket.onmessage = (e) => { try { const d = JSON.parse(e.data); if (d.event === 'connected' && d.type === 'technician_transcription') { t = true; check(); } else if (d.type === 'transcription') addTranscriptionBubble(d.text, d.speaker_label || 'Technicien', d.speaker_role || 'technician'); } catch {} };
                agentAudioWebSocket.onmessage = (e) => { try { const d = JSON.parse(e.data); if (d.event === 'connected' && d.type === 'agent_audio') { a = true; check(); } else if (d.type === 'transcription') addTranscriptionBubble(d.text, d.speaker_label || 'Agent', d.speaker_role || 'agent'); } catch {} };
                setTimeout(resolve, 5000);
            });
        }

        async function startTranscription() {
            try {
                agentMediaStream = await navigator.mediaDevices.getUserMedia({ audio: { sampleRate: 16000, channelCount: 1, echoCancellation: true, noiseSuppression: true, autoGainControl: true } });
                agentAudioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                const blob = new Blob([audioWorkletCode], { type: 'application/javascript' }), url = URL.createObjectURL(blob);
                try { await agentAudioContext.audioWorklet.addModule(url); } catch { await startTranscriptionFallback(); return; } finally { URL.revokeObjectURL(url); }
                agentAudioWorkletNode = new AudioWorkletNode(agentAudioContext, 'audio-stream-processor');
                agentAudioWorkletNode.port.onmessage = (e) => { if (e.data.type !== 'audio' || isAgentAudioMuted || !isCallActive || !agentAudioWebSocket || agentAudioWebSocket.readyState !== WebSocket.OPEN) return; const f = e.data.buffer, i = new Int16Array(f.length); for (let j = 0; j < f.length; j++) i[j] = Math.round(Math.max(-1, Math.min(1, f[j] * 2.5)) * 32767); agentAudioWebSocket.send(i.buffer); };
                const src = agentAudioContext.createMediaStreamSource(agentMediaStream); src.connect(agentAudioWorkletNode); agentAudioWorkletNode.connect(agentAudioContext.destination);
            } catch { alert('Erreur de transcription. Autorisez le microphone.'); }
        }

        async function startTranscriptionFallback() {
            const src = agentAudioContext.createMediaStreamSource(agentMediaStream), proc = agentAudioContext.createScriptProcessor(4096, 1, 1);
            proc.onaudioprocess = (e) => { if (isAgentAudioMuted || !isCallActive || !agentAudioWebSocket || agentAudioWebSocket.readyState !== WebSocket.OPEN) return; const f = e.inputBuffer.getChannelData(0), i = new Int16Array(f.length); for (let j = 0; j < f.length; j++) i[j] = Math.round(Math.max(-1, Math.min(1, f[j] * 2.5)) * 32767); agentAudioWebSocket.send(i.buffer); };
            src.connect(proc); proc.connect(agentAudioContext.destination); agentAudioWorkletNode = proc;
        }

        function addTranscriptionBubble(text, label, role) {
            const c = document.getElementById('transcriptionContent'), empty = c.querySelector('.transcription-empty');
            if (empty) empty.remove();
            const line = document.createElement('div'); line.className = `transcript-line ${role}`;
            line.innerHTML = `<div class="transcript-speaker">${label}</div><div class="transcript-text">${text}</div>`;
            c.appendChild(line); c.scrollTop = c.scrollHeight;
        }

        function displaySolutions(suggestions) {
            const c = document.getElementById('solutionContent'), sols = suggestions.filter(s => s.type === 'knowledge_base');
            if (!sols.length) return; c.innerHTML = '';
            sols.forEach(s => { const card = document.createElement('div'); card.className = 'solution-card'; card.innerHTML = `<h3>${s.title || 'Article'}</h3><p>${s.content}</p>${s.confidence ? `<span class="confidence-badge">‚úì ${(s.confidence * 100).toFixed(0)}%</span>` : ''}`; c.insertBefore(card, c.firstChild); });
        }
    </script>
</body>
</html>